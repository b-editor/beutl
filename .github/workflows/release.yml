name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  actions: read

jobs:
  determine-version:
    uses: ./.github/workflows/build-version.yml

  build-executable:
    needs: [ determine-version ]
    uses: ./.github/workflows/build-executable.yml
    with:
      semVer: ${{ needs.determine-version.outputs.semVer }}
      nugetVer: ${{ needs.determine-version.outputs.nugetVer }}
      asmVer: ${{ needs.determine-version.outputs.asmVer }}
      infoVer: ${{ needs.determine-version.outputs.infoVer }}

  build-windows-installer:
    needs: [ determine-version, build-executable ]
    uses: ./.github/workflows/build-windows-installer.yml
    with:
      semVer: ${{ needs.determine-version.outputs.semVer }}
      asmVer: ${{ needs.determine-version.outputs.asmVer }}

  build-debian-package:
    needs: [ determine-version, build-executable ]
    uses: ./.github/workflows/build-debian-package.yml
    with:
      semVer: ${{ needs.determine-version.outputs.semVer }}
      simpleVer: ${{ needs.determine-version.outputs.simpleVer }}
      revision: ${{ needs.determine-version.outputs.revision }}

  build-app-bundle:
    needs: [ determine-version ]
    uses: ./.github/workflows/build-macos-app.yml
    with:
      semVer: ${{ needs.determine-version.outputs.semVer }}
      nugetVer: ${{ needs.determine-version.outputs.nugetVer }}
      asmVer: ${{ needs.determine-version.outputs.asmVer }}
      infoVer: ${{ needs.determine-version.outputs.infoVer }}
    secrets:
      KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      CERTIFICATES_P12: ${{ secrets.CERTIFICATES_P12 }}
      CERTIFICATES_P12_PASSWORD: ${{ secrets.CERTIFICATES_P12_PASSWORD }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      TEAM_ID: ${{ secrets.TEAM_ID }}
      APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
      SIGNING_IDENTITY: ${{ secrets.SIGNING_IDENTITY }}

  build-nuget:
    needs: [ determine-version ]
    uses: ./.github/workflows/build-nuget.yml
    with:
      nugetVer: ${{ needs.determine-version.outputs.nugetVer }}
      asmVer: ${{ needs.determine-version.outputs.asmVer }}
      infoVer: ${{ needs.determine-version.outputs.infoVer }}

  create-release:
    needs: [ build-executable, build-windows-installer, build-debian-package, build-nuget, build-app-bundle ]
    runs-on: ubuntu-latest
    steps:
      - name: Download executable artifacts
        uses: actions/download-artifact@v7
        with:
          run-id: ${{ needs.build-executable.outputs.artifact-run-id }}
          path: artifacts

      - name: Download Windows installer artifacts
        uses: actions/download-artifact@v7
        with:
          run-id: ${{ needs.build-windows-installer.outputs.artifact-run-id }}
          path: artifacts

      - name: Download Debian package artifacts
        uses: actions/download-artifact@v7
        with:
          run-id: ${{ needs.build-debian-package.outputs.artifact-run-id }}
          path: artifacts

      - name: Download macOS app artifacts
        uses: actions/download-artifact@v7
        with:
          run-id: ${{ needs.build-app-bundle.outputs.artifact-run-id }}
          path: artifacts

      - name: Download NuGet artifacts
        uses: actions/download-artifact@v7
        with:
          run-id: ${{ needs.build-nuget.outputs.artifact-run-id }}
          path: artifacts

      - name: Print
        run: ls artifacts

      - name: Download metadata artifacts
        uses: actions/download-artifact@v6
        with:
          pattern: metadata-*
          path: metadata
          merge-multiple: false

      - name: Merge metadata
        run: |
          echo "Metadata files:"
          find metadata -name "asset_metadata.json" -type f

          # 全てのasset_metadata.jsonを結合
          echo '[]' > assets_metadata.json
          for file in $(find metadata -name "asset_metadata.json" -type f); do
            echo "Processing: $file"
            cat "$file"
            # 各ファイルの内容を配列に追加
            jq -s '.[0] + [.[1]]' assets_metadata.json "$file" > tmp.json && mv tmp.json assets_metadata.json
          done

          echo ""
          echo "Combined metadata:"
          cat assets_metadata.json | jq .

      - uses: ncipollo/release-action@v1
        id: create_release
        with:
          artifacts: "artifacts/**/*.zip,artifacts/**/*.deb,artifacts/beutl-setup/beutl-setup.exe,artifacts/beutl-standalone-setup/beutl-standalone-setup.exe,assets_metadata.json"
          draft: true
          makeLatest: true
          generateReleaseNotes: true
