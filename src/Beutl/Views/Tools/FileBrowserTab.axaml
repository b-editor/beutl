<UserControl x:Class="Beutl.Views.Tools.FileBrowserTab"
             xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:icons="using:FluentIcons.FluentAvalonia"
             xmlns:lang="using:Beutl.Language"
             xmlns:local="using:Beutl.Views.Tools"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:ui="using:FluentAvalonia.UI.Controls"
             xmlns:vm="using:Beutl.ViewModels.Tools"
             Name="Root"
             d:DesignHeight="450"
             d:DesignWidth="300"
             x:CompileBindings="True"
             x:DataType="vm:FileBrowserTabViewModel"
             DragDrop.AllowDrop="True"
             mc:Ignorable="d">

    <UserControl.Styles>
        <!--  共通コンテキストメニュー（file-itemクラスを持つBorderに適用）  -->
        <Style Selector="Border.file-item">
            <Setter Property="ContextMenu">
                <ContextMenu Opened="OnContextMenuOpened">
                    <MenuItem Click="OnOpenClick" Header="{x:Static lang:Strings.Open}">
                        <MenuItem.Icon>
                            <icons:SymbolIcon Symbol="Open" />
                        </MenuItem.Icon>
                    </MenuItem>
                    <Separator />
                    <MenuItem Click="OnRenameClick" Header="{x:Static lang:Strings.Rename}">
                        <MenuItem.Icon>
                            <icons:SymbolIcon Symbol="Rename" />
                        </MenuItem.Icon>
                    </MenuItem>
                    <MenuItem Click="OnDeleteClick" Header="{x:Static lang:Strings.Delete}">
                        <MenuItem.Icon>
                            <icons:SymbolIcon Symbol="Delete" />
                        </MenuItem.Icon>
                    </MenuItem>
                    <Separator />
                    <MenuItem Click="OnToggleFavoriteContextMenuClick"
                              Header="{x:Static lang:Strings.AddToFavorites}"
                              Tag="FavoriteToggle">
                        <MenuItem.Icon>
                            <icons:SymbolIcon Symbol="Star" />
                        </MenuItem.Icon>
                    </MenuItem>
                </ContextMenu>
            </Setter>
        </Style>
    </UserControl.Styles>

    <UserControl.Resources>
        <!--  アイコン表示用のItemTemplate  -->
        <DataTemplate x:Key="FileItemTemplate" x:DataType="vm:FileSystemItemViewModel">
            <Border Padding="4"
                    Background="Transparent"
                    Classes="file-item"
                    CornerRadius="4"
                    DoubleTapped="OnItemDoubleTapped"
                    ToolTip.Tip="{Binding MediaInfoText.Value}">
                <Interaction.Behaviors>
                    <local:FileItemDragBehavior />
                </Interaction.Behaviors>
                <Grid RowDefinitions="Auto,*">
                    <!--  サムネイルまたはアイコン  -->
                    <Panel Width="64"
                           Height="64"
                           VerticalAlignment="Top">
                        <Image IsVisible="{Binding HasThumbnail.Value}"
                               Source="{Binding Thumbnail.Value}"
                               Stretch="Uniform" />
                        <icons:SymbolIcon FontSize="48"
                                          IsVisible="{Binding !HasThumbnail.Value}"
                                          Symbol="{Binding IconSymbol}" />
                    </Panel>
                    <!--  ファイル名  -->
                    <TextBlock Grid.Row="1"
                               MaxWidth="80"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"
                               MaxLines="2"
                               Text="{Binding Name.Value}"
                               TextAlignment="Center"
                               TextTrimming="CharacterEllipsis"
                               TextWrapping="Wrap" />
                </Grid>
            </Border>
        </DataTemplate>

        <!--  リスト表示用のItemTemplate  -->
        <DataTemplate x:Key="ListItemTemplate" x:DataType="vm:FileSystemItemViewModel">
            <Border Padding="4,2"
                    Background="Transparent"
                    Classes="file-item"
                    DoubleTapped="OnItemDoubleTapped"
                    ToolTip.Tip="{Binding MediaInfoText.Value}">
                <Interaction.Behaviors>
                    <local:FileItemDragBehavior />
                </Interaction.Behaviors>
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <!--  サムネイルまたはアイコン  -->
                    <Panel Width="24" Height="24">
                        <Image IsVisible="{Binding HasThumbnail.Value}"
                               Source="{Binding Thumbnail.Value}"
                               Stretch="Uniform" />
                        <icons:SymbolIcon FontSize="20"
                                          IsVisible="{Binding !HasThumbnail.Value}"
                                          Symbol="{Binding IconSymbol}" />
                    </Panel>
                    <TextBlock VerticalAlignment="Center"
                               Text="{Binding Name.Value}"
                               TextTrimming="CharacterEllipsis" />
                </StackPanel>
            </Border>
        </DataTemplate>
    </UserControl.Resources>

    <Grid RowDefinitions="Auto,*">
        <!--  ツールバー  -->
        <Border Grid.Row="0"
                Padding="4"
                BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                BorderThickness="0,0,0,1">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <!--  上へボタン（ディレクトリブラウズ時のみ表示）  -->
                <Button Grid.Column="0"
                        Padding="6"
                        Click="OnOpenFolderClick"
                        IsVisible="{Binding !IsHomeView.Value}"
                        Theme="{StaticResource TransparentButton}"
                        ToolTip.Tip="{x:Static lang:Strings.OpenFolder}">
                    <icons:SymbolIcon FontSize="16" Symbol="OpenFolder" />
                </Button>

                <!--  パス表示（ディレクトリブラウズ時）  -->
                <ui:BreadcrumbBar Grid.Column="1"
                                  Margin="8,0"
                                  VerticalAlignment="Center"
                                  IsVisible="{Binding !IsHomeView.Value}"
                                  ItemClicked="BreadcrumbBarItemClicked"
                                  ItemsSource="{Binding BreadcrumbItems}">
                    <ui:BreadcrumbBar.ItemTemplate>
                        <DataTemplate x:DataType="vm:BreadcrumbPathItem">
                            <ui:BreadcrumbBarItem Content="{Binding}">
                                <ui:BreadcrumbBarItem.ContentTemplate>
                                    <DataTemplate DataType="vm:BreadcrumbPathItem">
                                        <TextBlock Text="{Binding Name}" />
                                    </DataTemplate>
                                </ui:BreadcrumbBarItem.ContentTemplate>
                            </ui:BreadcrumbBarItem>
                        </DataTemplate>
                    </ui:BreadcrumbBar.ItemTemplate>
                </ui:BreadcrumbBar>

                <!--  ホームヘッダー（ホームビュー時）  -->
                <TextBlock Grid.Column="1"
                           Margin="8,0"
                           VerticalAlignment="Center"
                           FontWeight="DemiBold"
                           IsVisible="{Binding IsHomeView.Value}"
                           Text="{x:Static lang:Strings.Home}" />

                <!--  表示モード切替とアクションボタン  -->
                <StackPanel Grid.Column="2"
                            Orientation="Horizontal"
                            Spacing="2">
                    <!--  表示モード切替（ディレクトリブラウズ時のみ）  -->
                    <Button Padding="6"
                            Click="OnCycleViewModeClick"
                            IsVisible="{Binding !IsHomeView.Value}"
                            Theme="{StaticResource TransparentButton}"
                            ToolTip.Tip="{Binding ViewMode.Value, Converter={x:Static vm:FileBrowserViewModeConverters.ToDisplayName}}">
                        <Panel>
                            <icons:SymbolIcon FontSize="16"
                                              IsVisible="{Binding ViewMode.Value, Converter={x:Static vm:FileBrowserViewModeConverters.IsList}}"
                                              Symbol="TextBulletListLtr" />
                            <icons:SymbolIcon FontSize="16"
                                              IsVisible="{Binding ViewMode.Value, Converter={x:Static vm:FileBrowserViewModeConverters.IsTree}}"
                                              Symbol="TextBulletListTree" />
                            <icons:SymbolIcon FontSize="16"
                                              IsVisible="{Binding ViewMode.Value, Converter={x:Static vm:FileBrowserViewModeConverters.IsIcon}}"
                                              Symbol="Grid" />
                        </Panel>
                    </Button>

                    <!--  新規フォルダ（ディレクトリブラウズ時のみ）  -->
                    <Button Padding="6"
                            Click="OnNewFolderClick"
                            IsVisible="{Binding !IsHomeView.Value}"
                            Theme="{StaticResource TransparentButton}"
                            ToolTip.Tip="{x:Static lang:Strings.NewFolder}">
                        <icons:SymbolIcon FontSize="16" Symbol="FolderAdd" />
                    </Button>

                    <!--  更新  -->
                    <Button Padding="6"
                            Click="OnRefreshClick"
                            Theme="{StaticResource TransparentButton}"
                            ToolTip.Tip="{x:Static lang:Strings.Refresh}">
                        <icons:SymbolIcon FontSize="16" Symbol="ArrowClockwise" />
                    </Button>

                    <!--  ホームボタン  -->
                    <Button Padding="6"
                            Click="OnHomeClick"
                            Theme="{StaticResource TransparentButton}"
                            ToolTip.Tip="{x:Static lang:Strings.Home}">
                        <icons:SymbolIcon FontSize="16" Symbol="Home" />
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!--  コンテンツ領域  -->
        <Panel Grid.Row="1">
            <!--  ホームビュー  -->
            <ScrollViewer IsVisible="{Binding IsHomeView.Value}">
                <StackPanel Spacing="0">
                    <!--  お気に入りセクション  -->
                    <Grid x:Name="favoritesSection" RowDefinitions="Auto,Auto">
                        <ToggleButton x:Name="favoritesToggle"
                                      Margin="8,4"
                                      IsChecked="True"
                                      Theme="{DynamicResource PropertyEditorMiniExpanderToggleButton}">
                            <TextBlock FontWeight="DemiBold" Text="{x:Static lang:Strings.Favorites}" />
                            <ToggleButton.Tag>
                                <ToggleButton Padding="4"
                                              IsChecked="{Binding IsFavoritesIconView.Value}"
                                              Theme="{StaticResource TransparentButton}">
                                    <Panel>
                                        <icons:SymbolIcon FontSize="14"
                                                          IsVisible="{Binding IsFavoritesIconView.Value}"
                                                          Symbol="Grid" />
                                        <icons:SymbolIcon FontSize="14"
                                                          IsVisible="{Binding !IsFavoritesIconView.Value}"
                                                          Symbol="TextBulletListLtr" />
                                    </Panel>
                                </ToggleButton>
                            </ToggleButton.Tag>
                        </ToggleButton>
                        <Panel x:Name="favoritesContent" Grid.Row="1">
                            <!--  リスト表示  -->
                            <ListBox IsVisible="{Binding !IsFavoritesIconView.Value}"
                                     ItemTemplate="{StaticResource ListItemTemplate}"
                                     ItemsSource="{Binding FavoriteItems}"
                                     SelectedItems="{Binding SelectedItems}"
                                     SelectionMode="Multiple">
                                <Interaction.Behaviors>
                                    <local:FileSelectionBehavior />
                                </Interaction.Behaviors>
                                <ListBox.Styles>
                                    <Style Selector="ListBoxItem">
                                        <Setter Property="Padding" Value="0" />
                                    </Style>
                                </ListBox.Styles>
                            </ListBox>
                            <!--  アイコン表示  -->
                            <ListBox IsVisible="{Binding IsFavoritesIconView.Value}"
                                     ItemTemplate="{StaticResource FileItemTemplate}"
                                     ItemsSource="{Binding FavoriteItems}"
                                     SelectedItems="{Binding SelectedItems}"
                                     SelectionMode="Multiple">
                                <Interaction.Behaviors>
                                    <local:FileSelectionBehavior />
                                </Interaction.Behaviors>
                                <ListBox.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Margin="4" />
                                    </ItemsPanelTemplate>
                                </ListBox.ItemsPanel>
                                <ListBox.Styles>
                                    <Style Selector="ListBoxItem">
                                        <Setter Property="Padding" Value="0" />
                                        <Setter Property="VerticalContentAlignment" Value="Stretch" />
                                    </Style>
                                </ListBox.Styles>
                            </ListBox>
                            <!--  空状態テキスト  -->
                            <TextBlock Margin="24,4"
                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                       IsVisible="{Binding !FavoriteItems.Count}"
                                       Text="{x:Static lang:Strings.NoFavorites}" />
                        </Panel>
                    </Grid>

                    <!--  プロジェクトディレクトリセクション  -->
                    <Grid RowDefinitions="Auto,Auto">
                        <ToggleButton x:Name="projectDirToggle"
                                      Margin="8,4"
                                      IsChecked="True"
                                      Theme="{DynamicResource PropertyEditorMiniExpanderToggleButton}">
                            <TextBlock FontWeight="DemiBold" Text="{x:Static lang:Strings.ProjectDirectory}" />
                            <ToggleButton.Tag>
                                <ToggleButton Padding="4"
                                              IsChecked="{Binding IsProjectDirIconView.Value}"
                                              Theme="{StaticResource TransparentButton}">
                                    <Panel>
                                        <icons:SymbolIcon FontSize="14"
                                                          IsVisible="{Binding IsProjectDirIconView.Value}"
                                                          Symbol="Grid" />
                                        <icons:SymbolIcon FontSize="14"
                                                          IsVisible="{Binding !IsProjectDirIconView.Value}"
                                                          Symbol="TextBulletListLtr" />
                                    </Panel>
                                </ToggleButton>
                            </ToggleButton.Tag>
                        </ToggleButton>
                        <Panel x:Name="projectDirContent" Grid.Row="1">
                            <!--  リスト表示  -->
                            <ListBox IsVisible="{Binding !IsProjectDirIconView.Value}"
                                     ItemTemplate="{StaticResource ListItemTemplate}"
                                     ItemsSource="{Binding ProjectDirectoryItems}"
                                     SelectedItems="{Binding SelectedItems}"
                                     SelectionMode="Multiple">
                                <Interaction.Behaviors>
                                    <local:FileSelectionBehavior />
                                </Interaction.Behaviors>
                                <ListBox.Styles>
                                    <Style Selector="ListBoxItem">
                                        <Setter Property="Padding" Value="0" />
                                    </Style>
                                </ListBox.Styles>
                            </ListBox>
                            <!--  アイコン表示  -->
                            <ListBox IsVisible="{Binding IsProjectDirIconView.Value}"
                                     ItemTemplate="{StaticResource FileItemTemplate}"
                                     ItemsSource="{Binding ProjectDirectoryItems}"
                                     SelectedItems="{Binding SelectedItems}"
                                     SelectionMode="Multiple">
                                <Interaction.Behaviors>
                                    <local:FileSelectionBehavior />
                                </Interaction.Behaviors>
                                <ListBox.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Margin="4" />
                                    </ItemsPanelTemplate>
                                </ListBox.ItemsPanel>
                                <ListBox.Styles>
                                    <Style Selector="ListBoxItem">
                                        <Setter Property="Padding" Value="0" />
                                        <Setter Property="VerticalContentAlignment" Value="Stretch" />
                                    </Style>
                                </ListBox.Styles>
                            </ListBox>
                        </Panel>
                    </Grid>

                    <!--  メディアファイルセクション  -->
                    <Grid x:Name="mediaFilesSection" RowDefinitions="Auto,Auto">
                        <ToggleButton x:Name="mediaFilesToggle"
                                      Margin="8,4"
                                      IsChecked="True"
                                      Theme="{DynamicResource PropertyEditorMiniExpanderToggleButton}">
                            <TextBlock FontWeight="DemiBold" Text="{x:Static lang:Strings.MediaFiles}" />
                            <ToggleButton.Tag>
                                <ToggleButton Padding="4"
                                              IsChecked="{Binding IsMediaFilesIconView.Value}"
                                              Theme="{StaticResource TransparentButton}">
                                    <Panel>
                                        <icons:SymbolIcon FontSize="14"
                                                          IsVisible="{Binding IsMediaFilesIconView.Value}"
                                                          Symbol="Grid" />
                                        <icons:SymbolIcon FontSize="14"
                                                          IsVisible="{Binding !IsMediaFilesIconView.Value}"
                                                          Symbol="TextBulletListLtr" />
                                    </Panel>
                                </ToggleButton>
                            </ToggleButton.Tag>
                        </ToggleButton>
                        <Panel x:Name="mediaFilesContent" Grid.Row="1">
                            <!--  検索中のProgressRing  -->
                            <StackPanel Margin="8"
                                        HorizontalAlignment="Center"
                                        IsVisible="{Binding IsLoadingMediaFiles.Value}"
                                        Orientation="Horizontal"
                                        Spacing="8">
                                <ui:ProgressRing Width="20"
                                                 Height="20"
                                                 IsIndeterminate="True" />
                                <TextBlock VerticalAlignment="Center"
                                           Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                           Text="{x:Static lang:Strings.SearchingMediaFiles}" />
                            </StackPanel>
                            <!--  ファイル一覧（読み込み完了後のみ表示）  -->
                            <Panel IsVisible="{Binding !IsLoadingMediaFiles.Value}">
                                <!--  リスト表示  -->
                                <ListBox IsVisible="{Binding !IsMediaFilesIconView.Value}"
                                         ItemTemplate="{StaticResource ListItemTemplate}"
                                         ItemsSource="{Binding MediaFileItems}"
                                         SelectedItems="{Binding SelectedItems}"
                                         SelectionMode="Multiple">
                                    <Interaction.Behaviors>
                                        <local:FileSelectionBehavior />
                                    </Interaction.Behaviors>
                                    <ListBox.Styles>
                                        <Style Selector="ListBoxItem">
                                            <Setter Property="Padding" Value="0" />
                                        </Style>
                                    </ListBox.Styles>
                                </ListBox>
                                <!--  アイコン表示  -->
                                <ListBox IsVisible="{Binding IsMediaFilesIconView.Value}"
                                         ItemTemplate="{StaticResource FileItemTemplate}"
                                         ItemsSource="{Binding MediaFileItems}"
                                         SelectedItems="{Binding SelectedItems}"
                                         SelectionMode="Multiple">
                                    <Interaction.Behaviors>
                                        <local:FileSelectionBehavior />
                                    </Interaction.Behaviors>
                                    <ListBox.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel Margin="4" />
                                        </ItemsPanelTemplate>
                                    </ListBox.ItemsPanel>
                                    <ListBox.Styles>
                                        <Style Selector="ListBoxItem">
                                            <Setter Property="Padding" Value="0" />
                                            <Setter Property="VerticalContentAlignment" Value="Stretch" />
                                        </Style>
                                    </ListBox.Styles>
                                </ListBox>
                            </Panel>
                            <!--  空状態テキスト  -->
                            <TextBlock Margin="24,4"
                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                       IsVisible="{Binding HasNoMediaFiles.Value}"
                                       Text="{x:Static lang:Strings.NoMediaFilesFound}" />
                        </Panel>
                    </Grid>
                </StackPanel>
            </ScrollViewer>

            <!--  ディレクトリブラウズビュー  -->
            <Panel IsVisible="{Binding !IsHomeView.Value}">
                <!--  アイコン表示  -->
                <ListBox x:Name="IconListBox"
                         IsVisible="{Binding ViewMode.Value, Converter={x:Static vm:FileBrowserViewModeConverters.IsIcon}}"
                         ItemTemplate="{StaticResource FileItemTemplate}"
                         ItemsSource="{Binding Items}"
                         SelectedItems="{Binding SelectedItems}"
                         SelectionMode="Multiple">
                    <Interaction.Behaviors>
                        <local:FileSelectionBehavior />
                    </Interaction.Behaviors>
                    <ListBox.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel Margin="4" />
                        </ItemsPanelTemplate>
                    </ListBox.ItemsPanel>
                    <ListBox.Styles>
                        <Style Selector="ListBoxItem">
                            <Setter Property="Padding" Value="0" />
                            <Setter Property="VerticalContentAlignment" Value="Stretch" />
                        </Style>
                    </ListBox.Styles>
                </ListBox>

                <!--  リスト表示  -->
                <ListBox x:Name="ListViewListBox"
                         IsVisible="{Binding ViewMode.Value, Converter={x:Static vm:FileBrowserViewModeConverters.IsList}}"
                         ItemTemplate="{StaticResource ListItemTemplate}"
                         ItemsSource="{Binding Items}"
                         SelectedItems="{Binding SelectedItems}"
                         SelectionMode="Multiple">
                    <Interaction.Behaviors>
                        <local:FileSelectionBehavior />
                    </Interaction.Behaviors>
                    <ListBox.Styles>
                        <Style Selector="ListBoxItem">
                            <Setter Property="Padding" Value="4,2" />
                        </Style>
                    </ListBox.Styles>
                </ListBox>

                <!--  ツリー表示  -->
                <TreeView IsVisible="{Binding ViewMode.Value, Converter={x:Static vm:FileBrowserViewModeConverters.IsTree}}"
                          ItemsSource="{Binding TreeRootItems}"
                          SelectedItems="{Binding SelectedItems}"
                          SelectionMode="Multiple">
                    <Interaction.Behaviors>
                        <local:FileSelectionBehavior />
                    </Interaction.Behaviors>
                    <TreeView.Styles>
                        <Style x:DataType="vm:FileSystemItemViewModel" Selector="TreeViewItem">
                            <Setter Property="IsExpanded" Value="{Binding IsExpanded.Value, Mode=TwoWay}" />
                        </Style>
                    </TreeView.Styles>
                    <TreeView.ItemTemplate>
                        <TreeDataTemplate ItemsSource="{Binding Children}">
                            <Border Background="Transparent"
                                    Classes="file-item"
                                    DoubleTapped="OnItemDoubleTapped"
                                    ToolTip.Tip="{Binding MediaInfoText.Value}">
                                <Interaction.Behaviors>
                                    <local:FileItemDragBehavior />
                                </Interaction.Behaviors>
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <Panel Width="24" Height="24">
                                        <Image IsVisible="{Binding HasThumbnail.Value}"
                                               Source="{Binding Thumbnail.Value}"
                                               Stretch="Uniform" />
                                        <icons:SymbolIcon FontSize="20"
                                                          IsVisible="{Binding !HasThumbnail.Value}"
                                                          Symbol="{Binding IconSymbol}" />
                                    </Panel>
                                    <TextBlock VerticalAlignment="Center" Text="{Binding Name.Value}" />
                                </StackPanel>
                            </Border>
                        </TreeDataTemplate>
                    </TreeView.ItemTemplate>
                </TreeView>
            </Panel>
        </Panel>
    </Grid>
</UserControl>
